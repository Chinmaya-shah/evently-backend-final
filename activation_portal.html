<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evently - Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-primary { background-color: #FFFFFF; color: #000000; }
        .btn-secondary { background-color: #333333; color: #FFFFFF; }
        .form-input { background-color: #1E1E1E; border-color: #333333; color: #FFFFFF; }
        select.form-input { appearance: none; }
    </style>
</head>
<body class="bg-black text-white flex items-center justify-center min-h-screen p-4">

<div id="portal-container" class="w-full max-w-4xl p-8 space-y-6 bg-[#121212] rounded-xl shadow-lg">

    <!-- Login Section -->
    <div id="login-section" class="max-w-md mx-auto">
        <h2 class="text-3xl font-bold text-center">Evently Admin Portal</h2>
        <div class="space-y-4 mt-6">
            <input id="admin-email" type="email" placeholder="Admin Email" class="w-full px-4 py-3 rounded-lg form-input focus:outline-none focus:ring-2 focus:ring-white">
            <input id="admin-password" type="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg form-input focus:outline-none focus:ring-2 focus:ring-white">
            <button id="login-btn" class="w-full py-3 rounded-lg btn-primary font-bold transition-transform transform active:scale-95">Login</button>
        </div>
    </div>

    <!-- Main Portal Section (hidden by default) -->
    <div id="portal-section" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Card Activation Column -->
            <div>
                <h2 class="text-2xl font-bold text-center mb-6">Card Activation</h2>
                <div class="space-y-4">
                    <input id="user-email" type="email" placeholder="Search Attendee by Email" class="w-full px-4 py-3 rounded-lg form-input focus:outline-none focus:ring-2 focus:ring-white">
                    <button id="search-btn" class="w-full py-3 rounded-lg btn-secondary font-bold transition-transform transform active:scale-95">Search User</button>
                </div>
                <div id="user-info" class="hidden mt-6 p-4 bg-[#1E1E1E] rounded-lg text-center space-y-2">
                    <p>User: <span id="user-name" class="font-bold"></span></p>
                    <p>Status: <span id="user-status" class="font-bold"></span></p>
                    <button id="prepare-btn" class="w-full py-3 rounded-lg btn-primary font-bold mt-2 transition-transform transform active:scale-95 disabled:bg-gray-500" disabled>Prepare for Activation</button>
                    <div id="code-display" class="hidden mt-4">
                        <p class="text-gray-400">Enter this code into the Kiosk:</p>
                        <p id="one-time-code" class="text-4xl font-mono tracking-widest my-2"></p>
                        <p id="timer" class="text-sm text-gray-500"></p>
                    </div>
                </div>
            </div>
            <!-- Gate Management Column -->
            <div>
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-center">Gate Management</h2>
                    <button id="refresh-gates-btn" class="p-2 rounded-full hover:bg-[#1E1E1E] transition" title="Refresh Gate List">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5"/></svg>
                    </button>
                </div>
                <div id="gate-list" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    <!-- Gate items will be injected here by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    <p id="message-area" class="text-center mt-4 h-6"></p>
</div>

<script>
    // --- CONFIG ---
    const API_BASE_URL = 'http://localhost:5000/api';
    let adminToken = null;
    let foundUserId = null;
    let countdownInterval = null;

    // --- DOM Element References ---
    const loginSection = document.getElementById('login-section');
    const portalSection = document.getElementById('portal-section');
    const userInfoDiv = document.getElementById('user-info');
    const codeDisplayDiv = document.getElementById('code-display');
    const messageArea = document.getElementById('message-area');
    const prepareBtn = document.getElementById('prepare-btn');
    const gateListDiv = document.getElementById('gate-list');

    // --- Helper to show messages ---
    const showMessage = (text, isError = false) => {
        messageArea.textContent = text;
        messageArea.className = `text-center mt-4 h-6 ${isError ? 'text-red-500' : 'text-green-500'}`;
    };

    // --- Event Listeners ---
    document.getElementById('login-btn').addEventListener('click', async () => {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        showMessage('');

        try {
            const res = await fetch(`${API_BASE_URL}/users/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (!res.ok || (data.role !== 'Admin' && data.role !== 'SuperAdmin')) {
                throw new Error('Invalid Admin credentials or insufficient permissions.');
            }

            adminToken = data.token;
            loginSection.classList.add('hidden');
            portalSection.classList.remove('hidden');
            await fetchAndRenderGates();
        } catch (err) {
            showMessage(err.message, true);
        }
    });

    document.getElementById('search-btn').addEventListener('click', async () => {
        const email = document.getElementById('user-email').value;
        showMessage('');
        userInfoDiv.classList.add('hidden');
        codeDisplayDiv.classList.add('hidden');
        if (!email) return showMessage('Please enter an email to search.', true);

        try {
            const res = await fetch(`${API_BASE_URL}/users/admin/find?email=${encodeURIComponent(email)}`, {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const user = await res.json();
            if (!res.ok) throw new Error(user.message);

            foundUserId = user._id;
            document.getElementById('user-name').textContent = user.name;

            let statusText = '';
            if (user.isCardActivated) {
                statusText = 'Card is already active.';
                prepareBtn.disabled = true;
            } else if (!user.isVerified) {
                statusText = 'User is NOT KYC verified.';
                prepareBtn.disabled = true;
            } else {
                statusText = 'Ready for activation.';
                prepareBtn.disabled = false;
            }
            document.getElementById('user-status').textContent = statusText;
            userInfoDiv.classList.remove('hidden');

        } catch (err) {
            showMessage(err.message, true);
        }
    });

    prepareBtn.addEventListener('click', async () => {
        showMessage('');
        prepareBtn.disabled = true;

        try {
            const res = await fetch(`${API_BASE_URL}/users/prepare-activation`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({ userId: foundUserId })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);

            document.getElementById('one-time-code').textContent = data.oneTimeCode;
            codeDisplayDiv.classList.remove('hidden');

            let timeLeft = 60;
            const timerP = document.getElementById('timer');
            if(countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                timerP.textContent = `Code expires in ${timeLeft}s`;
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(countdownInterval);
                    timerP.textContent = 'Code has expired.';
                    prepareBtn.disabled = false;
                }
            }, 1000);

        } catch (err) {
            showMessage(err.message, true);
            prepareBtn.disabled = false;
        }
    });

    // --- NEW GATE MANAGEMENT LOGIC ---
    const fetchAndRenderGates = async () => {
        if (!adminToken) return;
        gateListDiv.innerHTML = '<p class="text-gray-500 text-center">Loading gates...</p>';
        try {
            const [gatesRes, eventsRes] = await Promise.all([
                fetch(`${API_BASE_URL}/gates`, { headers: { 'Authorization': `Bearer ${adminToken}` } }),
                fetch(`${API_BASE_URL}/events`, { headers: { 'Authorization': `Bearer ${adminToken}` } })
            ]);

            if (!gatesRes.ok) throw new Error('Failed to fetch gates.');
            if (!eventsRes.ok) throw new Error('Failed to fetch events.');

            const gates = await gatesRes.json();
            const events = await eventsRes.json();

            gateListDiv.innerHTML = '';

            if (gates.length === 0) {
                gateListDiv.innerHTML = '<p class="text-gray-500 text-center">No gates have registered yet.</p>';
                return;
            }

            gates.forEach(gate => {
                const gateElement = document.createElement('div');
                gateElement.className = 'p-4 bg-[#1E1E1E] rounded-lg flex items-center justify-between';

                let eventOptions = '<option value="">-- Unassign --</option>';
                events.forEach(event => {
                    const isSelected = gate.activeEvent?._id === event._id;
                    eventOptions += `<option value="${event._id}" ${isSelected ? 'selected' : ''}>${event.name}</option>`;
                });

                gateElement.innerHTML = `
                        <div>
                            <p class="font-bold">${gate.name}</p>
                            <p class="text-sm text-gray-400">${gate.macAddress}</p>
                        </div>
                        <div class="flex items-center">
                            <select id="event-select-${gate._id}" class="form-input rounded-lg py-2 px-3 mr-2 text-sm">
                                ${eventOptions}
                            </select>
                            <button onclick="assignEventToGate('${gate._id}')" class="px-4 py-2 rounded-lg btn-secondary font-bold text-sm transition-transform transform active:scale-95">Assign</button>
                        </div>
                    `;
                gateListDiv.appendChild(gateElement);
            });
        } catch (err) {
            gateListDiv.innerHTML = `<p class="text-red-500 text-center">${err.message}</p>`;
        }
    };

    // This function needs to be on the global window object to be called by onclick
    window.assignEventToGate = async (gateId) => {
        const selectElement = document.getElementById(`event-select-${gateId}`);
        const eventId = selectElement.value;
        showMessage('');
        try {
            const res = await fetch(`${API_BASE_URL}/gates/${gateId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${adminToken}` },
                body: JSON.stringify({ activeEventId: eventId || null })
            });
            if (!res.ok) throw new Error('Failed to assign event.');
            showMessage('Event assigned to gate successfully!', false);
            await fetchAndRenderGates();
        } catch (err) {
            showMessage(err.message, true);
        }
    };

    document.getElementById('refresh-gates-btn').addEventListener('click', fetchAndRenderGates);
</script>
</body>
</html>