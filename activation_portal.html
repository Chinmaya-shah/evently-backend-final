<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evently - Card Activation Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-primary { background-color: #FFFFFF; color: #000000; }
        .btn-secondary { background-color: #1E1E1E; color: #FFFFFF; }
        .form-input { background-color: #1E1E1E; border-color: #333333; color: #FFFFFF; }
    </style>
</head>
<body class="bg-black text-white flex items-center justify-center min-h-screen">

<div class="w-full max-w-md p-8 space-y-6 bg-[#121212] rounded-xl shadow-lg">

    <!-- Login Section -->
    <div id="login-section">
        <h2 class="text-2xl font-bold text-center">Admin Portal Login</h2>
        <div class="space-y-4 mt-6">
            <input id="admin-email" type="email" placeholder="Admin Email" class="w-full px-4 py-3 rounded-lg form-input focus:outline-none focus:ring-2 focus:ring-white">
            <input id="admin-password" type="password" placeholder="Password" class="w-full px-4 py-3 rounded-lg form-input focus:outline-none focus:ring-2 focus:ring-white">
            <button id="login-btn" class="w-full py-3 rounded-lg btn-primary font-bold transition-transform transform active:scale-95">Login</button>
        </div>
    </div>

    <!-- Main Portal Section (hidden by default) -->
    <div id="portal-section" class="hidden">
        <h2 class="text-2xl font-bold text-center">Card Activation</h2>
        <div class="space-y-4 mt-6">
            <input id="user-email" type="email" placeholder="Search Attendee by Email" class="w-full px-4 py-3 rounded-lg form-input focus:outline-none focus:ring-2 focus:ring-white">
            <button id="search-btn" class="w-full py-3 rounded-lg btn-secondary font-bold transition-transform transform active:scale-95">Search User</button>
        </div>

        <!-- User Info and Activation Code Display -->
        <div id="user-info" class="hidden mt-6 p-4 bg-[#1E1E1E] rounded-lg text-center space-y-2">
            <p>User: <span id="user-name" class="font-bold"></span></p>
            <p>Status: <span id="user-status" class="font-bold"></span></p>
            <button id="prepare-btn" class="w-full py-3 rounded-lg btn-primary font-bold mt-2 transition-transform transform active:scale-95" disabled>Prepare for Activation</button>
            <div id="code-display" class="hidden mt-4">
                <p class="text-gray-400">Enter this code into the Arduino Kiosk:</p>
                <p id="one-time-code" class="text-4xl font-mono tracking-widest my-2"></p>
                <p id="timer" class="text-sm text-gray-500"></p>
            </div>
        </div>
    </div>
    <p id="message-area" class="text-center mt-4 h-6"></p>
</div>

<script>
    const API_URL = 'http://localhost:5000/api/users';
    let adminToken = null;
    let foundUserId = null;
    let countdownInterval = null;

    // --- DOM Element References ---
    const loginSection = document.getElementById('login-section');
    const portalSection = document.getElementById('portal-section');
    const userInfoDiv = document.getElementById('user-info');
    const codeDisplayDiv = document.getElementById('code-display');
    const messageArea = document.getElementById('message-area');
    const prepareBtn = document.getElementById('prepare-btn');

    // --- Helper to show messages ---
    const showMessage = (text, isError = false) => {
        messageArea.textContent = text;
        messageArea.className = `text-center mt-4 h-6 ${isError ? 'text-red-500' : 'text-green-500'}`;
    };

    // --- Event Listeners ---

    // Login Logic
    document.getElementById('login-btn').addEventListener('click', async () => {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        showMessage('');

        try {
            const res = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            if (!res.ok || (data.role !== 'Admin' && data.role !== 'SuperAdmin')) {
                throw new Error('Invalid Admin credentials or insufficient permissions.');
            }

            adminToken = data.token;
            loginSection.classList.add('hidden');
            portalSection.classList.remove('hidden');
        } catch (err) {
            showMessage(err.message, true);
        }
    });

    // Search User Logic
    document.getElementById('search-btn').addEventListener('click', async () => {
        const email = document.getElementById('user-email').value;
        showMessage('');
        userInfoDiv.classList.add('hidden');
        codeDisplayDiv.classList.add('hidden');
        if (!email) return showMessage('Please enter an email to search.', true);

        try {
            const res = await fetch(`${API_URL}/admin/find?email=${encodeURIComponent(email)}`, {
                headers: { 'Authorization': `Bearer ${adminToken}` }
            });
            const user = await res.json();
            if (!res.ok) throw new Error(user.message);

            foundUserId = user._id;
            document.getElementById('user-name').textContent = user.name;

            let statusText = '';
            if (user.isCardActivated) {
                statusText = 'Card is already active.';
                prepareBtn.disabled = true;
            } else if (!user.isVerified) {
                statusText = 'User is NOT KYC verified.';
                prepareBtn.disabled = true;
            } else {
                statusText = 'Ready for activation.';
                prepareBtn.disabled = false;
            }
            document.getElementById('user-status').textContent = statusText;
            userInfoDiv.classList.remove('hidden');

        } catch (err) {
            showMessage(err.message, true);
        }
    });

    // Prepare Activation Logic
    prepareBtn.addEventListener('click', async () => {
        showMessage('');
        prepareBtn.disabled = true;

        try {
            const res = await fetch(`${API_URL}/prepare-activation`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${adminToken}`
                },
                body: JSON.stringify({ userId: foundUserId })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message);

            document.getElementById('one-time-code').textContent = data.oneTimeCode;
            codeDisplayDiv.classList.remove('hidden');

            let timeLeft = 60;
            const timerP = document.getElementById('timer');
            if(countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                timerP.textContent = `Code expires in ${timeLeft}s`;
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(countdownInterval);
                    timerP.textContent = 'Code has expired.';
                    prepareBtn.disabled = false;
                }
            }, 1000);

        } catch (err) {
            showMessage(err.message, true);
            prepareBtn.disabled = false;
        }
    });
</script>
</body>
</html>